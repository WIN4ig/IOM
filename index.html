<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Рубрикатор ИОМ-КР / Должности</title>
  <style>
    :root { 
      --bg: #0b0f16; 
      --card: #141a24; 
      --text: #e8eef6; 
      --muted: #9fb0c3; 
      --accent: #6aa9ff; 
      --shadow: rgba(0,0,0,0.2); 
      --border: #223048;
      --header-height: 10vh; /* Относительная высота шапки */
      --pagination-height: 8vh; /* Относительная высота пагинации */
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; height: 100%; }
    body { 
      font: 1rem/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial; 
      background: var(--bg); 
      color: var(--text); 
      overflow: hidden; /* Отключаем скролл тела */
      height: 100%; /* Полная высота для flex */
      margin: 0; /* Убираем дефолтные отступы */
      position: relative; /* Для правильного позиционирования */
    }
    .wrap { 
      max-width: 90vw; /* Относительная максимальная ширина */
      margin: 0 auto; /* Центрируем без верхнего/нижнего отступа */
      display: flex; 
      flex-direction: column; 
      min-height: 100dvh; /* Минимальная высота для поддержки контента */
      padding: 0 1rem; /* Относительные отступы */
    }
    h1 { font-size: 1.75rem; margin: 0 0 1rem; }
    .sub { color: var(--muted); margin-bottom: 1.5rem; font-size: 0.875rem; }
    .controls { display: flex; flex-wrap: wrap; gap: 0.75rem; margin: 1rem 0 1.5rem; }
    .input, select { flex: 1; background: var(--card); border: 1px solid var(--border); color: var(--text); padding: 0.625rem 0.75rem; border-radius: 0.75rem; outline: none; transition: border 0.2s; }
    .input:focus, select:focus { border-color: var(--accent); }
    .meta { font-size: 0.8125rem; color: var(--muted); margin: 0.5rem 0 1rem; display: flex; justify-content: space-between; align-items: center; }
    .results { font-size: 0.875rem; color: var(--text); font-weight: bold; margin-bottom: 0.75rem; display: none; }
    .list { 
      display: grid; 
      gap: 0.75rem; 
      overflow-y: auto; 
      scrollbar-width: thin; 
      scrollbar-color: var(--muted) var(--card); 
      max-height: calc(100dvh - var(--header-height) - var(--pagination-height) - 2.5rem); /* Ограничение высоты с учётом шапки, пагинации и отступов */
    }
    .list::-webkit-scrollbar { width: 0.5rem; }
    .list::-webkit-scrollbar-track { background: var(--card); border-radius: 0.25rem; }
    .list::-webkit-scrollbar-thumb { background: var(--muted); border-radius: 0.25rem; }
    .list::-webkit-scrollbar-thumb:hover { background: var(--accent); }
    .item { 
      background: var(--card); 
      border: 1px solid var(--border); 
      padding: 0.625rem; 
      border-radius: 0.875rem; 
      box-shadow: 0 0.125rem 0.25rem var(--shadow); 
      transition: transform 0.2s, box-shadow 0.2s; 
      min-height: 3.75rem; /* Относительная минимальная высота */
      display: flex; 
      flex-direction: column; 
      justify-content: center; /* Центрируем содержимое */
    }
    .item:hover { transform: translateY(-0.125rem); box-shadow: 0 0.25rem 0.5rem var(--shadow); }
    .iom { font-weight: 600; font-size: 1rem; }
    .pos { color: var(--muted); font-size: 0.875rem; }
    .error-message {
      margin: 0.75rem 0;
      padding: 0.625rem;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      text-align: center;
      box-shadow: 0 0.125rem 0.25rem var(--shadow);
    }
    .error-message.error { background: #ffe5e5; color: #a00; }
    .error-message.empty { background: #fff3cd; color: #856404; }
    a { color: var(--accent); text-decoration: none; transition: color 0.2s; }
    a:hover { color: #4a8dff; }
    .loader { text-align: center; padding: 1.25rem; color: var(--muted); }
    .pagination { 
      display: flex; 
      justify-content: center; 
      gap: 0.625rem; 
      padding: 0.625rem; 
      background: var(--bg); 
      box-shadow: 0 -0.125rem 0.25rem var(--shadow); 
      z-index: 10; 
      height: var(--pagination-height); /* Относительная высота */
      flex-shrink: 0; /* Не сжимается */
    }
    .page-btn { background: var(--card); border: 1px solid var(--border); color: var(--text); padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; transition: background 0.2s; }
    .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .page-btn:hover:not(:disabled) { background: #1e2740; }
    .to-top { 
      position: fixed; 
      bottom: 5.625rem; /* 90px в относительных единицах */
      right: 1.25rem; /* 20px в относительных единицах */
      background: var(--card); 
      border: 1px solid var(--border); 
      color: var(--text); 
      width: 2.5rem; /* 40px */
      height: 2.5rem; /* 40px */
      border-radius: 50%; 
      cursor: pointer; 
      display: none; 
      z-index: 10; 
      box-shadow: 0 0.125rem 0.25rem var(--shadow); 
      transition: opacity 0.3s, transform 0.2s; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
    }
    .to-top.visible { display: flex; opacity: 1; }
    .to-top:hover { background: #1e2740; transform: scale(1.1); }
    .page-size-container { display: flex; align-items: center; gap: 0.3125rem; }
    .page-size-label { font-size: 0.8125rem; color: var(--muted); white-space: nowrap; }
    .page-size-select { width: 5.625rem; text-align: center; } /* 90px в rem */

    /* Responsive improvements */
    @media (max-width: 720px) {
      .controls { flex-direction: column; }
      .input, select { width: 100%; }
      h1 { font-size: 1.5rem; }
      .wrap { padding: 0 0.75rem; }
      .list { 
        max-height: calc(100dvh - var(--header-height) - var(--pagination-height) - 1.25rem); /* Уменьшенное значение для мобильных */
      }
      .pagination { padding: 0.5rem; height: 6vh; } /* Уменьшенная относительная высота */
      .to-top { bottom: 5rem; right: 0.75rem; width: 2.25rem; height: 2.25rem; }
      .meta { flex-direction: column; align-items: flex-start; gap: 0.3125rem; }
      .page-size-container { margin-top: 0.3125rem; justify-content: flex-end; }
      .page-size-select { width: 5.625rem; }
    }
    @media (max-width: 480px) {
      body { font-size: 0.875rem; }
      .item { min-height: 3.125rem; } /* 50px в rem */
      .iom { font-size: 0.9375rem; }
      .pos { font-size: 0.8125rem; }
      .pagination { gap: 0.375rem; height: 5.5vh; }
      .page-btn { padding: 0.375rem 0.625rem; font-size: 0.875rem; }
      .page-size-select { width: 5rem; } /* 80px в rem */
      .list { 
        max-height: calc(100dvh - var(--header-height) - var(--pagination-height) - 0.625rem); /* Минимальное значение для маленьких экранов */
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Рубрикатор: ИОМ-КР / Должности</h1>
    <div class="sub">Выберите врачебную специальность или воспользуйтесь поиском по специальности/ИОМ</div>

    <div class="controls">
      <input id="search" class="input" placeholder="Поиск по ИОМ/Должности…" />
      <select id="spec"></select>
    </div>

    <div id="error-message" class="error-message error" style="display: none;">
      Ошибка загрузки данных. Попробуйте обновить страницу позже.
    </div>

    <div id="empty-message" class="error-message empty" style="display: none;">
      Ничего не найдено. Измените фильтры или поиск.
    </div>

    <div class="meta" id="meta"></div>
    <div class="results" id="results"></div>
    <div id="list" class="list"></div>
    <div id="loader" class="loader" style="display:none">Загрузка данных...</div>
    <div class="pagination" id="pagination" style="display:none">
      <button class="page-btn" id="prev" aria-label="Предыдущая страница">Назад</button>
      <span id="page-info"></span>
      <button class="page-btn" id="next" aria-label="Следующая страница">Далее</button>
    </div>
  </div>
  <button class="to-top" id="to-top" aria-label="Вернуться наверх">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M12 19V5M5 12l7-7 7 7"/>
    </svg>
  </button>

<script>
(async function(){
  const dataUrl = 'data/matrix.json?v=' + Date.now(); // кэш-бан
  const specEl = document.getElementById('spec');
  const listEl = document.getElementById('list');
  const errorMessageEl = document.getElementById('error-message');
  const emptyMessageEl = document.getElementById('empty-message');
  const searchEl = document.getElementById('search');
  const metaEl = document.getElementById('meta');
  const resultsEl = document.getElementById('results');
  const loaderEl = document.getElementById('loader');
  const paginationEl = document.getElementById('pagination');
  const prevBtn = document.getElementById('prev');
  const nextBtn = document.getElementById('next');
  const pageInfoEl = document.getElementById('page-info');
  const toTopBtn = document.getElementById('to-top');

  let raw = { items: [], specialties: [], updated_at: null };
  let currentPage = 1;
  let pageSize = 50; // Начальное значение
  let isDataLoaded = false; // Флаг успешной загрузки данных

  // Показываем лоадер
  loaderEl.style.display = 'block';

  try {
    const res = await fetch(dataUrl);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    raw = await res.json();
    isDataLoaded = true; // Устанавливаем флаг, если данные загружены
  } catch (e) {
    listEl.innerHTML = '';
    errorMessageEl.style.display = 'block';
    console.error(e);
    loaderEl.style.display = 'none';
    toTopBtn.style.display = 'none'; // Явно скрываем кнопку при ошибке
    return;
  }

  loaderEl.style.display = 'none';

  // Заполняем селект специальностей
  specEl.innerHTML = `<option value="">Все специальности</option>` + raw.specialties.map(s => `<option>${s}</option>`).join('');

  // Метаданные
  const d = raw.updated_at ? new Date(raw.updated_at).toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' }) : '—';
  metaEl.innerHTML = `${raw.items.length} записей • обновлено: ${d} • источник Минздрав`;

  function updateToTopVisibility() {
    if (isDataLoaded && listEl.children.length > 0 && emptyMessageEl.style.display === 'none') {
      const hasScroll = listEl.scrollHeight > listEl.clientHeight;
      const isScrolled = listEl.scrollTop > 0;
      toTopBtn.style.display = hasScroll && isScrolled ? 'flex' : 'none'; // Явное управление display
      toTopBtn.classList.toggle('visible', hasScroll && isScrolled);
    } else {
      toTopBtn.style.display = 'none'; // Явно скрываем кнопку
      toTopBtn.classList.remove('visible');
    }
  }

  function render(page = 1) {
    // Сохраняем позицию прокрутки внутри списка
    const scrollPosition = listEl.scrollTop;

    const q = (searchEl.value || '').trim().toLowerCase();
    const spec = specEl.value;
    let items = raw.items;
    if (spec) items = items.filter(i => i.specialty === spec);
    if (q) {
      items = items.filter(i =>
        (i.iom && i.iom.toLowerCase().includes(q)) ||
        (i.position && i.position.toLowerCase().includes(q))
      );
    }

    // Показываем количество найденных ИОМов
    if (q || spec) {
      resultsEl.style.display = 'block';
      resultsEl.textContent = `Найдено: ${items.length} ИОМ`;
    } else {
      resultsEl.style.display = 'none';
    }

    // Управление видимостью поля pageSize
    const pageSizeContainer = document.createElement('div');
    pageSizeContainer.className = 'page-size-container';
    const existingSelect = metaEl.querySelector('#page-size-select');
    if (items.length > 1 && !existingSelect) {
      pageSizeContainer.innerHTML = 'ИОМ на странице: <select id="page-size-select" class="page-size-select"><option value="10">10</option><option value="20">20</option><option value="50" selected>50</option><option value="100">100</option></select>';
      metaEl.appendChild(pageSizeContainer);
      const pageSizeSelect = document.getElementById('page-size-select');
      pageSizeSelect.addEventListener('change', () => {
        let newSize = parseInt(pageSizeSelect.value, 10);
        if (isNaN(newSize) || newSize < 1) newSize = 50;
        pageSize = newSize;
        currentPage = 1; // Сбрасываем на первую страницу
        render();
      });
    } else if (items.length <= 1 && existingSelect) {
      existingSelect.parentElement.remove();
    }

    // Пагинация
    const totalPages = Math.ceil(items.length / pageSize);
    const start = (page - 1) * pageSize;
    const paginatedItems = items.slice(start, start + pageSize);

    listEl.innerHTML = paginatedItems.map((i, index) => `
      <div class="item" data-index="${index}">
        <div class="iom">${i.iom || '—'}</div>
        <div class="pos" style="margin-top:0.375rem"><span style="opacity:.6">Специальность:</span> ${i.specialty || '—'}</div>
      </div>
    `).join('');

    // Управляем отображением сообщений
    errorMessageEl.style.display = 'none'; // Скрываем сообщение об ошибке загрузки
    emptyMessageEl.style.display = items.length ? 'none' : 'block'; // Показываем "Ничего не найдено" при пустом списке

    // Обновляем видимость кнопки "Наверх"
    updateToTopVisibility();

    // Пагинация контролы
    if (totalPages > 1) {
      paginationEl.style.display = 'flex';
      pageInfoEl.textContent = `Страница ${page} из ${totalPages}`;
      prevBtn.disabled = page === 1;
      nextBtn.disabled = page === totalPages;
    } else {
      paginationEl.style.display = 'none';
    }

    // Восстанавливаем прокрутку внутри списка
    listEl.scrollTop = scrollPosition;
  }

  // Обработчик для кнопки "Наверх"
  toTopBtn.addEventListener('click', () => {
    listEl.scrollTo({ top: 0, behavior: 'smooth' });
  });

  specEl.addEventListener('change', () => { currentPage = 1; render(); });
  searchEl.addEventListener('input', () => { currentPage = 1; render(); });
  prevBtn.addEventListener('click', () => { 
    if (currentPage > 1) { 
      currentPage--; 
      render(currentPage); 
    } 
  });
  nextBtn.addEventListener('click', () => { 
    currentPage++; 
    render(currentPage); 
  });

  // Обновляем видимость кнопки "Наверх" при скролле
  listEl.addEventListener('scroll', () => {
    updateToTopVisibility();
  });

  render();
})();
</script>
</body>
</html>